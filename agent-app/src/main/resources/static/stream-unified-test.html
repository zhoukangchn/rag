<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆå¹¶SSEæµå¼å¤„ç†æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .section h3 {
            margin-top: 0;
            color: #007bff;
        }
        .log {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            border-radius: 5px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid transparent;
        }
        .log-entry.step-started {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        .log-entry.step-completed {
            background-color: #e8f5e8;
            border-left-color: #4caf50;
        }
        .log-entry.step-failed {
            background-color: #ffebee;
            border-left-color: #f44336;
        }
        .log-entry.progress {
            background-color: #fff3e0;
            border-left-color: #ff9800;
        }
        .log-entry.error {
            background-color: #ffebee;
            border-left-color: #f44336;
        }
        .log-entry.completed {
            background-color: #e8f5e8;
            border-left-color: #4caf50;
            font-weight: bold;
        }
        .log-entry.data {
            background-color: #f3e5f5;
            border-left-color: #9c27b0;
        }
        .log-entry.connection {
            background-color: #e0f2f1;
            border-left-color: #009688;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            align-items: center;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 300px;
        }
        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .input-group input, .input-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover:not(:disabled) {
            background-color: #218838;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover:not(:disabled) {
            background-color: #c82333;
        }
        .status {
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        .stat-card .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-card .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ åˆå¹¶SSEæµå¼å¤„ç†æµ‹è¯•</h1>
            <p>ä¸€æ¬¡è°ƒç”¨å®Œæˆè¿æ¥å»ºç«‹å’ŒæŸ¥è¯¢å¤„ç†çš„æ–°ç«¯ç‚¹æµ‹è¯•</p>
            <div style="margin-top: 15px;">
                <a href="unified-query-test.html" style="display: inline-block; background-color: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px;">
                    ğŸ”— ä½“éªŒç»Ÿä¸€æ¥å£
                </a>
                <a href="sse-test.html" style="display: inline-block; background-color: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px;">
                    ğŸ“¡ ä¼ ç»Ÿæµå¼æµ‹è¯•
                </a>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸ“¡ æ–°ç«¯ç‚¹ï¼š/ai/stream (åˆå¹¶æ¨¡å¼)</h3>
            <div class="controls">
                <div class="input-group">
                    <label for="messageInput">æŸ¥è¯¢æ¶ˆæ¯:</label>
                    <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„æŸ¥è¯¢æ¶ˆæ¯">å‘Šè¯‰æˆ‘ä¸€ä¸ªå…³äºäººå·¥æ™ºèƒ½çš„æœ‰è¶£æ•…äº‹ï¼Œè¦æ±‚ç”ŸåŠ¨æœ‰è¶£ã€‚</textarea>
                </div>
                <div class="input-group">
                    <label for="sessionIdInput">ä¼šè¯ID (å¯é€‰):</label>
                    <input type="text" id="sessionIdInput" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                </div>
            </div>
            
            <div class="controls">
                <button id="streamGetBtn" onclick="startStreamGet()">GET æµå¼æŸ¥è¯¢</button>
                <button id="streamPostBtn" onclick="startStreamPost()">POST æµå¼æŸ¥è¯¢</button>
                <button id="clearBtn" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
                <button id="stopBtn" onclick="stopStream()" disabled class="danger">åœæ­¢æµ</button>
            </div>
            
            <div id="status" class="status disconnected">å‡†å¤‡å°±ç»ª</div>
            
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div id="eventsCount" class="stat-value">0</div>
                    <div class="stat-label">æ¥æ”¶äº‹ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div id="currentStep" class="stat-value">-</div>
                    <div class="stat-label">å½“å‰æ­¥éª¤</div>
                </div>
                <div class="stat-card">
                    <div id="elapsedTime" class="stat-value">0s</div>
                    <div class="stat-label">è€—æ—¶</div>
                </div>
                <div class="stat-card">
                    <div id="sessionIdDisplay" class="stat-value">-</div>
                    <div class="stat-label">ä¼šè¯ID</div>
                </div>
            </div>
            
            <div id="log" class="log"></div>
        </div>
        
        <div class="comparison">
            <div class="section">
                <h3>ğŸ“Š æ–°æ–¹å¼ä¼˜åŠ¿</h3>
                <ul>
                    <li>âœ… ä¸€æ¬¡è°ƒç”¨å®Œæˆè¿æ¥+æŸ¥è¯¢</li>
                    <li>âœ… è‡ªåŠ¨ä¼šè¯IDç”Ÿæˆ</li>
                    <li>âœ… è‡ªåŠ¨è¿æ¥ç®¡ç†</li>
                    <li>âœ… æ›´ç®€å•çš„å®¢æˆ·ç«¯ä»£ç </li>
                    <li>âœ… æ”¯æŒGETå’ŒPOSTä¸¤ç§æ–¹å¼</li>
                    <li>âœ… å¯é…ç½®è‡ªåŠ¨å…³é—­</li>
                </ul>
            </div>
            
            <div class="section">
                <h3>ğŸ”„ ä¼ ç»Ÿæ–¹å¼å¯¹æ¯”</h3>
                <ul>
                    <li>âŒ éœ€è¦å…ˆè°ƒç”¨ /ai/stream/connect</li>
                    <li>âŒ å†è°ƒç”¨ /ai/stream/chat</li>
                    <li>âŒ æ‰‹åŠ¨ç®¡ç†ä¼šè¯ID</li>
                    <li>âŒ éœ€è¦æ˜¾å¼å…³é—­è¿æ¥</li>
                    <li>âŒ æ›´å¤æ‚çš„é”™è¯¯å¤„ç†</li>
                    <li>âŒ å®¢æˆ·ç«¯ä»£ç æ›´å¤š</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <p><strong>GETæ–¹å¼ï¼š</strong> <code>GET /ai/stream?message=your_query&sessionId=optional</code></p>
            <p><strong>POSTæ–¹å¼ï¼š</strong> <code>POST /ai/stream</code> å¸¦JSONè¯·æ±‚ä½“</p>
            <pre><code>{
  "message": "your query",
  "sessionId": "optional",
  "autoClose": true,
  "options": {}
}</code></pre>
        </div>
    </div>

    <script>
        let eventSource = null;
        let sessionId = null;
        let currentProgress = 0;
        let eventsCount = 0;
        let startTime = null;
        let timerInterval = null;
        
        function startStreamGet() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢æ¶ˆæ¯');
                return;
            }
            
            // è·å–å¯é€‰çš„ä¼šè¯ID
            const customSessionId = document.getElementById('sessionIdInput').value.trim();
            
            // é‡ç½®çŠ¶æ€
            resetStats();
            setStatus('connecting', 'æ­£åœ¨è¿æ¥...');
            
            // æ„å»ºURL
            let url = `/ai/stream?message=${encodeURIComponent(message)}`;
            if (customSessionId) {
                url += `&sessionId=${encodeURIComponent(customSessionId)}`;
                sessionId = customSessionId;
            }
            
            // å¯åŠ¨è®¡æ—¶å™¨
            startTimer();
            
            // åˆ›å»ºSSEè¿æ¥
            eventSource = new EventSource(url);
            
            setupEventListeners();
            
            // æ›´æ–°UI
            document.getElementById('streamGetBtn').disabled = true;
            document.getElementById('streamPostBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            addLogEntry('REQUEST', `å‘èµ·GETè¯·æ±‚: ${url}`, 'connection');
        }
        
        function startStreamPost() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢æ¶ˆæ¯');
                return;
            }
            
            // è·å–å¯é€‰çš„ä¼šè¯ID
            const customSessionId = document.getElementById('sessionIdInput').value.trim();
            
            // é‡ç½®çŠ¶æ€
            resetStats();
            setStatus('connecting', 'æ­£åœ¨è¿æ¥...');
            
            const requestBody = {
                message: message,
                sessionId: customSessionId || undefined,
                autoClose: true,
                options: {}
            };
            
            // å¯åŠ¨è®¡æ—¶å™¨
            startTimer();
            
            // å‘é€POSTè¯·æ±‚å¹¶åˆ›å»ºSSEè¿æ¥
            fetch('/ai/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // ä»å“åº”åˆ›å»ºEventSource
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            handleStreamComplete();
                            return;
                        }
                        
                        const chunk = decoder.decode(value, { stream: true });
                        processStreamChunk(chunk);
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                addLogEntry('ERROR', `POSTè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                setStatus('disconnected', 'è¿æ¥å¤±è´¥');
                resetUI();
            });
            
            // æ›´æ–°UI
            document.getElementById('streamGetBtn').disabled = true;
            document.getElementById('streamPostBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            addLogEntry('REQUEST', `å‘èµ·POSTè¯·æ±‚: /ai/stream`, 'connection');
        }
        
        function setupEventListeners() {
            eventSource.onopen = function(event) {
                setStatus('connected', 'è¿æ¥æˆåŠŸï¼Œæ­£åœ¨å¤„ç†...');
                addLogEntry('CONNECTION', 'SSEè¿æ¥å»ºç«‹æˆåŠŸ', 'connection');
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleProgressEvent(data);
                } catch (e) {
                    addLogEntry('ERROR', `è§£ææ¶ˆæ¯å¤±è´¥: ${event.data}`, 'error');
                }
            };
            
            eventSource.onerror = function(event) {
                addLogEntry('ERROR', 'è¿æ¥å‘ç”Ÿé”™è¯¯', 'error');
                setStatus('disconnected', 'è¿æ¥é”™è¯¯');
                resetUI();
            };
            
            // ç›‘å¬ç‰¹å®šäº‹ä»¶ç±»å‹
            ['STEP_STARTED', 'STEP_COMPLETED', 'STEP_FAILED', 'PROGRESS', 'COMPLETED', 'ERROR', 'DATA'].forEach(eventType => {
                eventSource.addEventListener(eventType, function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleProgressEvent(data);
                    } catch (e) {
                        addLogEntry('ERROR', `è§£æ${eventType}äº‹ä»¶å¤±è´¥: ${event.data}`, 'error');
                    }
                });
            });
        }
        
        function processStreamChunk(chunk) {
            const lines = chunk.split('\n');
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const jsonData = line.substring(6);
                        if (jsonData.trim()) {
                            const data = JSON.parse(jsonData);
                            handleProgressEvent(data);
                        }
                    } catch (e) {
                        console.warn('æ— æ³•è§£ææµæ•°æ®:', line);
                    }
                }
            }
        }
        
        function handleStreamComplete() {
            addLogEntry('STREAM', 'æµå¼ä¼ è¾“å®Œæˆ', 'completed');
            setStatus('disconnected', 'å¤„ç†å®Œæˆ');
            resetUI();
        }
        
        function stopStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            addLogEntry('USER', 'ç”¨æˆ·ä¸»åŠ¨åœæ­¢æµå¼å¤„ç†', 'step-failed');
            setStatus('disconnected', 'å·²åœæ­¢');
            resetUI();
        }
        
        function handleProgressEvent(data) {
            eventsCount++;
            document.getElementById('eventsCount').textContent = eventsCount;
            
            const eventType = data.eventType;
            const stepName = data.stepName || 'unknown';
            const message = data.message || '';
            const progress = data.progressPercentage;
            const error = data.error;
            const eventData = data.data;
            
            // æ›´æ–°å½“å‰æ­¥éª¤æ˜¾ç¤º
            if (stepName && stepName !== 'unknown') {
                document.getElementById('currentStep').textContent = stepName;
            }
            
            // æ›´æ–°ä¼šè¯IDæ˜¾ç¤º
            if (!sessionId && data.sessionId) {
                sessionId = data.sessionId;
                document.getElementById('sessionIdDisplay').textContent = sessionId.substring(0, 8) + '...';
            }
            
            let cssClass = 'step-started';
            let logMessage = `[${eventType}] ${stepName}: ${message}`;
            
            switch (eventType) {
                case 'STEP_STARTED':
                    cssClass = 'step-started';
                    break;
                case 'STEP_COMPLETED':
                    cssClass = 'step-completed';
                    break;
                case 'STEP_FAILED':
                    cssClass = 'step-failed';
                    if (error) {
                        logMessage += ` | é”™è¯¯: ${error}`;
                    }
                    break;
                case 'PROGRESS':
                    cssClass = 'progress';
                    if (progress) {
                        updateProgressBar(progress);
                        logMessage += ` | è¿›åº¦: ${progress.toFixed(1)}%`;
                    }
                    break;
                case 'COMPLETED':
                    cssClass = 'completed';
                    updateProgressBar(100);
                    setStatus('disconnected', 'å¤„ç†å®Œæˆ');
                    resetUI();
                    break;
                case 'ERROR':
                    cssClass = 'error';
                    if (error) {
                        logMessage += ` | é”™è¯¯: ${error}`;
                    }
                    setStatus('disconnected', 'å¤„ç†å‡ºé”™');
                    resetUI();
                    break;
                case 'DATA':
                    cssClass = 'data';
                    if (eventData) {
                        logMessage += ` | æ•°æ®: ${JSON.stringify(eventData).substring(0, 100)}${JSON.stringify(eventData).length > 100 ? '...' : ''}`;
                    }
                    break;
                default:
                    if (eventType === 'HEARTBEAT') {
                        return; // è·³è¿‡å¿ƒè·³æ—¥å¿—
                    }
            }
            
            addLogEntry(eventType, logMessage, cssClass);
        }
        
        function setStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }
        
        function updateProgressBar(progress) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = progress + '%';
            currentProgress = progress;
        }
        
        function addLogEntry(type, message, cssClass) {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + cssClass;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            const log = document.getElementById('log');
            log.innerHTML = '';
            resetStats();
        }
        
        function resetStats() {
            eventsCount = 0;
            currentProgress = 0;
            sessionId = null;
            document.getElementById('eventsCount').textContent = '0';
            document.getElementById('currentStep').textContent = '-';
            document.getElementById('elapsedTime').textContent = '0s';
            document.getElementById('sessionIdDisplay').textContent = '-';
            updateProgressBar(0);
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function resetUI() {
            document.getElementById('streamGetBtn').disabled = false;
            document.getElementById('streamPostBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                if (startTime) {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('elapsedTime').textContent = elapsed + 's';
                }
            }, 1000);
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('SYSTEM', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿›è¡Œåˆå¹¶SSEæµå¼å¤„ç†æµ‹è¯•', 'connection');
        });
    </script>
</body>
</html> 