<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合并SSE流式处理测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .section h3 {
            margin-top: 0;
            color: #007bff;
        }
        .log {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            border-radius: 5px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid transparent;
        }
        .log-entry.step-started {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        .log-entry.step-completed {
            background-color: #e8f5e8;
            border-left-color: #4caf50;
        }
        .log-entry.step-failed {
            background-color: #ffebee;
            border-left-color: #f44336;
        }
        .log-entry.progress {
            background-color: #fff3e0;
            border-left-color: #ff9800;
        }
        .log-entry.error {
            background-color: #ffebee;
            border-left-color: #f44336;
        }
        .log-entry.completed {
            background-color: #e8f5e8;
            border-left-color: #4caf50;
            font-weight: bold;
        }
        .log-entry.data {
            background-color: #f3e5f5;
            border-left-color: #9c27b0;
        }
        .log-entry.connection {
            background-color: #e0f2f1;
            border-left-color: #009688;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            align-items: center;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 300px;
        }
        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .input-group input, .input-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover:not(:disabled) {
            background-color: #218838;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover:not(:disabled) {
            background-color: #c82333;
        }
        .status {
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        .stat-card .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-card .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 合并SSE流式处理测试</h1>
            <p>一次调用完成连接建立和查询处理的新端点测试</p>
            <div style="margin-top: 15px;">
                <a href="unified-query-test.html" style="display: inline-block; background-color: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px;">
                    🔗 体验统一接口
                </a>
                <a href="sse-test.html" style="display: inline-block; background-color: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px;">
                    📡 传统流式测试
                </a>
            </div>
        </div>
        
        <div class="section">
            <h3>📡 新端点：/ai/stream (合并模式)</h3>
            <div class="controls">
                <div class="input-group">
                    <label for="messageInput">查询消息:</label>
                    <textarea id="messageInput" placeholder="输入您的查询消息">告诉我一个关于人工智能的有趣故事，要求生动有趣。</textarea>
                </div>
                <div class="input-group">
                    <label for="sessionIdInput">会话ID (可选):</label>
                    <input type="text" id="sessionIdInput" placeholder="留空自动生成">
                </div>
            </div>
            
            <div class="controls">
                <button id="streamGetBtn" onclick="startStreamGet()">GET 流式查询</button>
                <button id="streamPostBtn" onclick="startStreamPost()">POST 流式查询</button>
                <button id="clearBtn" onclick="clearLog()">清除日志</button>
                <button id="stopBtn" onclick="stopStream()" disabled class="danger">停止流</button>
            </div>
            
            <div id="status" class="status disconnected">准备就绪</div>
            
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div id="eventsCount" class="stat-value">0</div>
                    <div class="stat-label">接收事件数</div>
                </div>
                <div class="stat-card">
                    <div id="currentStep" class="stat-value">-</div>
                    <div class="stat-label">当前步骤</div>
                </div>
                <div class="stat-card">
                    <div id="elapsedTime" class="stat-value">0s</div>
                    <div class="stat-label">耗时</div>
                </div>
                <div class="stat-card">
                    <div id="sessionIdDisplay" class="stat-value">-</div>
                    <div class="stat-label">会话ID</div>
                </div>
            </div>
            
            <div id="log" class="log"></div>
        </div>
        
        <div class="comparison">
            <div class="section">
                <h3>📊 新方式优势</h3>
                <ul>
                    <li>✅ 一次调用完成连接+查询</li>
                    <li>✅ 自动会话ID生成</li>
                    <li>✅ 自动连接管理</li>
                    <li>✅ 更简单的客户端代码</li>
                    <li>✅ 支持GET和POST两种方式</li>
                    <li>✅ 可配置自动关闭</li>
                </ul>
            </div>
            
            <div class="section">
                <h3>🔄 传统方式对比</h3>
                <ul>
                    <li>❌ 需要先调用 /ai/stream/connect</li>
                    <li>❌ 再调用 /ai/stream/chat</li>
                    <li>❌ 手动管理会话ID</li>
                    <li>❌ 需要显式关闭连接</li>
                    <li>❌ 更复杂的错误处理</li>
                    <li>❌ 客户端代码更多</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h3>📋 使用说明</h3>
            <p><strong>GET方式：</strong> <code>GET /ai/stream?message=your_query&sessionId=optional</code></p>
            <p><strong>POST方式：</strong> <code>POST /ai/stream</code> 带JSON请求体</p>
            <pre><code>{
  "message": "your query",
  "sessionId": "optional",
  "autoClose": true,
  "options": {}
}</code></pre>
        </div>
    </div>

    <script>
        let eventSource = null;
        let sessionId = null;
        let currentProgress = 0;
        let eventsCount = 0;
        let startTime = null;
        let timerInterval = null;
        
        function startStreamGet() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                alert('请输入查询消息');
                return;
            }
            
            // 获取可选的会话ID
            const customSessionId = document.getElementById('sessionIdInput').value.trim();
            
            // 重置状态
            resetStats();
            setStatus('connecting', '正在连接...');
            
            // 构建URL
            let url = `/ai/stream?message=${encodeURIComponent(message)}`;
            if (customSessionId) {
                url += `&sessionId=${encodeURIComponent(customSessionId)}`;
                sessionId = customSessionId;
            }
            
            // 启动计时器
            startTimer();
            
            // 创建SSE连接
            eventSource = new EventSource(url);
            
            setupEventListeners();
            
            // 更新UI
            document.getElementById('streamGetBtn').disabled = true;
            document.getElementById('streamPostBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            addLogEntry('REQUEST', `发起GET请求: ${url}`, 'connection');
        }
        
        function startStreamPost() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                alert('请输入查询消息');
                return;
            }
            
            // 获取可选的会话ID
            const customSessionId = document.getElementById('sessionIdInput').value.trim();
            
            // 重置状态
            resetStats();
            setStatus('connecting', '正在连接...');
            
            const requestBody = {
                message: message,
                sessionId: customSessionId || undefined,
                autoClose: true,
                options: {}
            };
            
            // 启动计时器
            startTimer();
            
            // 发送POST请求并创建SSE连接
            fetch('/ai/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // 从响应创建EventSource
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            handleStreamComplete();
                            return;
                        }
                        
                        const chunk = decoder.decode(value, { stream: true });
                        processStreamChunk(chunk);
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                addLogEntry('ERROR', `POST请求失败: ${error.message}`, 'error');
                setStatus('disconnected', '连接失败');
                resetUI();
            });
            
            // 更新UI
            document.getElementById('streamGetBtn').disabled = true;
            document.getElementById('streamPostBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            addLogEntry('REQUEST', `发起POST请求: /ai/stream`, 'connection');
        }
        
        function setupEventListeners() {
            eventSource.onopen = function(event) {
                setStatus('connected', '连接成功，正在处理...');
                addLogEntry('CONNECTION', 'SSE连接建立成功', 'connection');
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleProgressEvent(data);
                } catch (e) {
                    addLogEntry('ERROR', `解析消息失败: ${event.data}`, 'error');
                }
            };
            
            eventSource.onerror = function(event) {
                addLogEntry('ERROR', '连接发生错误', 'error');
                setStatus('disconnected', '连接错误');
                resetUI();
            };
            
            // 监听特定事件类型
            ['STEP_STARTED', 'STEP_COMPLETED', 'STEP_FAILED', 'PROGRESS', 'COMPLETED', 'ERROR', 'DATA'].forEach(eventType => {
                eventSource.addEventListener(eventType, function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleProgressEvent(data);
                    } catch (e) {
                        addLogEntry('ERROR', `解析${eventType}事件失败: ${event.data}`, 'error');
                    }
                });
            });
        }
        
        function processStreamChunk(chunk) {
            const lines = chunk.split('\n');
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const jsonData = line.substring(6);
                        if (jsonData.trim()) {
                            const data = JSON.parse(jsonData);
                            handleProgressEvent(data);
                        }
                    } catch (e) {
                        console.warn('无法解析流数据:', line);
                    }
                }
            }
        }
        
        function handleStreamComplete() {
            addLogEntry('STREAM', '流式传输完成', 'completed');
            setStatus('disconnected', '处理完成');
            resetUI();
        }
        
        function stopStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            addLogEntry('USER', '用户主动停止流式处理', 'step-failed');
            setStatus('disconnected', '已停止');
            resetUI();
        }
        
        function handleProgressEvent(data) {
            eventsCount++;
            document.getElementById('eventsCount').textContent = eventsCount;
            
            const eventType = data.eventType;
            const stepName = data.stepName || 'unknown';
            const message = data.message || '';
            const progress = data.progressPercentage;
            const error = data.error;
            const eventData = data.data;
            
            // 更新当前步骤显示
            if (stepName && stepName !== 'unknown') {
                document.getElementById('currentStep').textContent = stepName;
            }
            
            // 更新会话ID显示
            if (!sessionId && data.sessionId) {
                sessionId = data.sessionId;
                document.getElementById('sessionIdDisplay').textContent = sessionId.substring(0, 8) + '...';
            }
            
            let cssClass = 'step-started';
            let logMessage = `[${eventType}] ${stepName}: ${message}`;
            
            switch (eventType) {
                case 'STEP_STARTED':
                    cssClass = 'step-started';
                    break;
                case 'STEP_COMPLETED':
                    cssClass = 'step-completed';
                    break;
                case 'STEP_FAILED':
                    cssClass = 'step-failed';
                    if (error) {
                        logMessage += ` | 错误: ${error}`;
                    }
                    break;
                case 'PROGRESS':
                    cssClass = 'progress';
                    if (progress) {
                        updateProgressBar(progress);
                        logMessage += ` | 进度: ${progress.toFixed(1)}%`;
                    }
                    break;
                case 'COMPLETED':
                    cssClass = 'completed';
                    updateProgressBar(100);
                    setStatus('disconnected', '处理完成');
                    resetUI();
                    break;
                case 'ERROR':
                    cssClass = 'error';
                    if (error) {
                        logMessage += ` | 错误: ${error}`;
                    }
                    setStatus('disconnected', '处理出错');
                    resetUI();
                    break;
                case 'DATA':
                    cssClass = 'data';
                    if (eventData) {
                        logMessage += ` | 数据: ${JSON.stringify(eventData).substring(0, 100)}${JSON.stringify(eventData).length > 100 ? '...' : ''}`;
                    }
                    break;
                default:
                    if (eventType === 'HEARTBEAT') {
                        return; // 跳过心跳日志
                    }
            }
            
            addLogEntry(eventType, logMessage, cssClass);
        }
        
        function setStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }
        
        function updateProgressBar(progress) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = progress + '%';
            currentProgress = progress;
        }
        
        function addLogEntry(type, message, cssClass) {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + cssClass;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            const log = document.getElementById('log');
            log.innerHTML = '';
            resetStats();
        }
        
        function resetStats() {
            eventsCount = 0;
            currentProgress = 0;
            sessionId = null;
            document.getElementById('eventsCount').textContent = '0';
            document.getElementById('currentStep').textContent = '-';
            document.getElementById('elapsedTime').textContent = '0s';
            document.getElementById('sessionIdDisplay').textContent = '-';
            updateProgressBar(0);
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function resetUI() {
            document.getElementById('streamGetBtn').disabled = false;
            document.getElementById('streamPostBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                if (startTime) {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('elapsedTime').textContent = elapsed + 's';
                }
            }, 1000);
        }
        
        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('SYSTEM', '页面加载完成，准备进行合并SSE流式处理测试', 'connection');
        });
    </script>
</body>
</html> 